load_module modules/ngx_http_js_module.so;

worker_processes 1;

events {
    worker_connections 1024;
}

http {

    # Import JWT extraction logic (njs)
    js_import jwt from jwt_extract.js;

    # Define $user_id globally so it can be used by limit_req_zone
    js_set $user_id jwt.extract_user_id;

    # Extended log format including derived user id
    log_format main_ext '$remote_addr - $status - $request - '
                        'uid=$user_id - rt=$request_time';

    access_log /var/log/nginx/access.log main_ext;

    # Rate limit zones
    # Per authenticated user id derived from JWT (or "anonymous")
    limit_req_zone $user_id zone=user_zone:10m rate=60r/m;

    # Per IP for login endpoint
    limit_req_zone $binary_remote_addr zone=login_zone:10m rate=5r/m;

    upstream secure_api {
        server secure_api:8000;
    }

    server {
        listen 80;

        # Return HTTP 429 when rate limit is exceeded (instead of default 503)
        limit_req_status 429;

        # Security headers
        add_header X-Frame-Options DENY;
        add_header X-Content-Type-Options nosniff;
        add_header X-XSS-Protection "1; mode=block";

        # Login endpoint protection (IP-based rate limiting)
        location /auth/login {
            limit_req zone=login_zone burst=3 nodelay;

            proxy_pass http://secure_api;

            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
        }

        # All other API routes
        location / {

            # Force X-User-Id header to the derived user id (do not trust client-supplied header)
            proxy_set_header X-User-Id $user_id;

            # Apply per-user rate limiting
            limit_req zone=user_zone burst=10 nodelay;

            # Strict CORS configuration
            add_header Access-Control-Allow-Origin http://localhost:3000;
            add_header Access-Control-Allow-Methods "GET, POST";
            add_header Access-Control-Allow-Headers "Authorization, Content-Type";

            if ($request_method = OPTIONS) {
                return 204;
            }

            proxy_pass http://secure_api;

            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
        }
    }
}